<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Carga v18 (Suministro Compuesto)</title>
    <style>
/* --- ESTILOS GENERALES --- */
:root {
    --color-primario: #007bff;
    --color-primario-hover: #0056b3;
    --color-secundario: #6c757d;
    --color-peligro: #dc3545;
    --color-exito: #28a745;
    --color-fondo: #f4f7f6;
    --color-tarjeta: #ffffff;
    --color-texto: #333;
    --color-titulo: #005a9c;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--color-fondo);
    color: var(--color-texto);
    margin: 0;
    padding: 20px;
}

.logo-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
    margin-bottom: 20px;
    grid-column: 1 / -1;
}
.logo-container img.logo {
    height: 180px; 
    width: auto;
    cursor: pointer;
}

#toggle-mode-button {
    padding: 10px 15px;
    font-size: 0.9rem;
    font-weight: bold;
}

/* --- ESTILOS MODO OFICINA --- */
#office-mode {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

h1, h2, h3 {
    color: var(--color-titulo);
    border-bottom: 2px solid var(--color-titulo);
    padding-bottom: 5px;
    grid-column: 1 / -1;
    margin-top: 0;
}

#office-mode h1 {
    grid-column: 1 / -1;
    margin-bottom: 0;
}

h2 { margin-top: 10px; }

.container {
    background-color: var(--color-tarjeta);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 25px;
    overflow: hidden;
}

#main-processor {
    grid-column: 1 / -1;
    background-color: #e6f7ff;
    border: 1px solid #b3e0ff;
}

/* Layout de las bases de datos */
#product-manager, #truck-manager { grid-column: span 1; }
#warehouse-manager { grid-column: 1 / -1; margin-top: 20px; }


#prepared-plans-container {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 15px;
    border-radius: 4px;
    margin-top: 20px;
}
#prepared-plans-list li { font-weight: bold; }

#transfer-text-container {
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    padding: 15px;
    border-radius: 4px;
    margin-top: 10px;
}
#transfer-text-area {
    width: 98%;
    height: 100px;
    font-size: 0.8rem;
    font-family: "Courier New", Courier, monospace;
}

textarea {
    width: 98%;
    height: 150px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: "Courier New", Courier, monospace;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

button {
    background-color: var(--color-primario);
    color: white;
    border: none;
    padding: 12px 18px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s ease;
    margin-right: 10px;
    margin-top: 5px;
}

button:hover { background-color: var(--color-primario-hover); }
button.danger { background-color: var(--color-peligro); }
button.danger:hover { background-color: #c82333; }
button.secondary { background-color: var(--color-secundario); }
button.secondary:hover { background-color: #5a6268; }
button.success { background-color: var(--color-exito); }
button.success:hover { background-color: #218838; }

#result, #product-import-notification {
    margin-top: 20px; padding: 15px; border-radius: 4px;
    font-size: 1.1rem; line-height: 1.6; font-weight: 500;
}
#result.success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
#result.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
#product-import-notification { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }

input[type="text"], input[type="number"] {
    width: calc(100% - 24px); padding: 10px; margin-bottom: 10px;
    border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem;
}
input[type="number"] { width: 100px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-weight: 500; margin-bottom: 5px; }
.form-inline { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
.form-inline label { margin-bottom: 0; flex-basis: 100px; flex-shrink: 0; }
.form-inline input[type="text"] { flex-grow: 2; margin-bottom: 0; }
.form-inline input[type="number"] { flex-grow: 1; margin-bottom: 0; }
.form-inline button { flex-shrink: 0; margin-top: 0; }

#product-db-list, #truck-db-list, #warehouse-db-list, #op-inventory-list {
    height: 300px; overflow-y: auto; border: 1px solid #eee;
    padding: 10px; background-color: #fafafa; border-radius: 4px; margin-top: 15px;
}
.db-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
.db-item:nth-child(even) { background-color: #f9f9f9; }
.db-item:last-child { border-bottom: none; }
.db-item span { font-family: "Courier New", Courier, monospace; font-size: 0.9rem; word-break: break-word; padding-right: 10px; }
.db-item .db-item-desc { flex-grow: 1; }
.db-item button { padding: 5px 8px; font-size: 0.8rem; margin-right: 0; margin-left: 5px; }

.tab-content { display: none; }
.tab-content.active { display: block; }
.tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
.tab-button { padding: 10px 15px; cursor: pointer; background-color: #f1f1f1; border: 1px solid #ccc; border-bottom: none; margin-bottom: -2px; border-radius: 4px 4px 0 0; font-weight: 500; }
.tab-button.active { background-color: #fff; border-bottom: 2px solid #fff; color: var(--color-primario); }

#csv-paste-area, #csv-paste-warehouse-area { display: none; margin-top: 15px; }
#csv-paste-area textarea, #csv-paste-warehouse-area textarea { height: 100px; }
#load-order-list { list-style-type: decimal; padding-left: 20px; }
#load-order-list li { padding: 8px; border-bottom: 1px solid #eee; }
#load-order-list li strong { color: var(--color-titulo); font-size: 1.1rem; }

#warehouse-checkout-container { 
    background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin-top: 15px; border-radius: 4px; 
    display: none; /* Oculto por defecto en V18 */
}

/* --- ESTILOS MODO OPERARIO --- */
#operator-mode {
    display: none; 
    background-color: #2c3e50; 
    color: #ecf0f1; 
    padding: 20px;
    box-sizing: border-box;
    min-height: 100vh;
}

#operator-mode .logo-container {
     border-bottom: 2px solid var(--color-primario);
     padding-bottom: 15px;
}

.operator-screen {
    display: none; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding-top: 20px;
    width: 100%;
}

#operator-mode h2, #operator-mode h3 {
    color: #ffffff;
    border-bottom-color: var(--color-primario);
}

#operator-mode button {
    font-size: 1.2rem;
    font-weight: bold;
    padding: 20px;
    width: 100%;
    max-width: 400px;
    margin-bottom: 15px;
    box-sizing: border-box;
}

#op-truck-step-screen h2 { font-size: 1.5rem; color: #95a5a6; }
#step-instruction {
    font-size: 1.8rem; font-weight: bold;
    color: #ffffff; margin: 40px 0;
}

#operator-incident-button.listening {
    background-color: var(--color-peligro);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

#report-content, #journey-report-content, #inventory-report-content {
    background-color: #34495e; color: #ecf0f1; padding: 15px;
    border-radius: 8px; text-align: left;
    white-space: pre-wrap; 
    font-family: "Courier New", Courier, monospace;
    width: 100%; max-width: 500px;
    box-sizing: border-box; margin-bottom: 20px;
}

#op-paste-textarea {
    height: 150px;
    width: 100%;
    max-width: 400px;
    margin: 20px 0;
}

#op-truck-list-screen .truck-button { background-color: var(--color-primario); }
#op-truck-list-screen .truck-button:hover { background-color: var(--color-primario-hover); }
#op-truck-list-screen h3 { margin-top: 40px; }

#op-inventory-list {
    background-color: #34495e; /* Fondo oscuro para el modo operario */
    color: #ecf0f1;
    border: 1px solid #4a637d;
}
#op-inventory-list li {
    padding: 8px;
    border-bottom: 1px solid #4a637d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#op-inventory-list li:last-child { border-bottom: none; }


/* --- Bot√≥n de Asistencia --- */
#assistance-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    font-size: 1.5rem;
    font-weight: bold;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    z-index: 2000;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

    </style>
</head>
<body>

    <div class="logo-container">
        <a href="https://www.ia2060.com" target="_blank" rel="noopener noreferrer">
            <img src="https://i.ibb.co/cXhr44XB/LOGO-IA2060-IMG.jpg" alt="Logo de IA2060" class="logo" border="0">
        </a>
        <button id="toggle-mode-button" class="secondary">Cambiar a Modo Operario</button>
    </div>

    <div id="office-mode">
        <h1>Gestor de Carga (v18 - Suministro Compuesto)</h1>

        <div id="main-processor" class="container">
            <h2>1. Procesador de Pedidos</h2>
            <div class="form-group">
                <label for="pedido-input">Pega aqu√≠ el "Resumen Diario de Venta":</label>
                <textarea id="pedido-input" placeholder="Pega el texto del pedido aqu√≠..."></textarea>
            </div>
            <button id="process-button">Procesar y A√±adir a Lote</button>

            <div id="product-import-notification" style="display: none;"></div>
            <div id="result"></div>

            <div id="warehouse-checkout-container">
                <h3>‚úÖ Retiro de Almac√©n (Checkout)</h3>
                <pre id="checkout-report-content" style="white-space: pre-wrap; font-family: 'Courier New', monospace;"></pre>
                <button id="share-checkout-whatsapp-button" class="success">Enviar Aviso de Retiro (WhatsApp)</button>
            </div>

            <div id="prepared-plans-container" style="display: none;">
                <h3>Planes de Carga Preparados</h3>
                <ul id="prepared-plans-list"></ul>
                <button id="generate-transfer-button" class="success">Generar Texto de Transferencia</button>
                <button id="clear-plans-button" class="danger">Limpiar Lote</button>
            </div>

            <div id="transfer-text-container" style="display: none;">
                <h3>Texto de Transferencia (Copiar y Enviar al Operario)</h3>
                <textarea id="transfer-text-area" readonly></textarea>
                <button id="copy-transfer-text-button">Copiar Texto</button>
            </div>
        </div>

        <div id="product-manager" class="container">
            <h2>2. Base de Datos de Productos</h2>
            <div class="tabs">
                <button class="tab-button active" onclick="openTab('tab-add-product', this)">A√±adir / Editar</button>
                <button class="tab-button" onclick="openTab('tab-view-products', this)">Ver Lista</button>
            </div>
            <div id="tab-add-product" class="tab-content active">
                <div class="form-inline">
                    <label for="product-code">C√≥digo:</label>
                    <input type="text" id="product-code" placeholder="Ej: 9001">
                </div>
                <div class="form-inline">
                    <label for="product-desc">Descripci√≥n:</label>
                    <input type="text" id="product-desc" placeholder="Ej: BARRIL 50 LITROS">
                </div>
                <div class="form-inline">
                    <label for="product-volume">Volumen (m¬≥):</label>
                    <input type="number" id="product-volume" step="0.0001" min="0" placeholder="Ej: 0.070">
                </div>
                <button id="add-product-button">A√±adir / Actualizar Producto</button>
                <button id="clear-product-form-button" class="secondary">Limpiar</button>
                <hr style="margin: 20px 0;"><button id="toggle-csv-button" class="secondary">Importar Lista (CSV)</button>
                <div id="csv-paste-area">
                    <label for="csv-input">Pega aqu√≠ tu lista (Formato: `Codigo,Descripcion,Volumen`):</label>
                    <textarea id="csv-input" placeholder="9001,BARRIL 50 LITROS,0.070&#10;9002,BARRIL 30 LITROS,0.048"></textarea>
                    <button id="import-csv-button">Importar CSV</button>
                </div>
            </div>
            <div id="tab-view-products" class="tab-content">
                <input type="text" id="search-product" placeholder="Buscar producto por c√≥digo o descripci√≥n...">
                <div id="product-db-list"></div>
                <button id="export-products-button" class="secondary" style="margin-top: 15px;">Exportar Productos (CSV)</button>
                <button id="clear-products-button" class="danger" style="margin-top: 15px;">Borrar TODOS los Productos</button>
            </div>
        </div>

        <div id="truck-manager" class="container">
            <h2>3. Base de Datos de Camiones</h2>
            <div class="form-inline">
                <label for="truck-name">Nombre:</label>
                <input type="text" id="truck-name" placeholder="Ej: DISGAL 2">
            </div>
            <div class="form-inline">
                <label for="truck-capacity">Capacidad (m¬≥):</label>
                <input type="number" id="truck-capacity" step="0.1" min="0" placeholder="Ej: 45.5">
            </div>
            <button id="add-truck-button">A√±adir / Actualizar Cami√≥n</button>
            <hr style="margin: 20px 0;"><h3>Lista de Camiones Registrados</h3>
            <div id="truck-db-list"></div>
            <button id="clear-trucks-button" class="danger" style="margin-top: 15px;">Borrar TODOS los Camiones</button>
        </div>

        <div id="warehouse-manager" class="container">
            <h2>4. Gesti√≥n de Almac√©n Propio (Inventario)</h2>
            <p><strong>El stock se RESTA autom√°ticamente al procesar un pedido.</strong></p>
            <div class="form-group">
                <label for="warehouse-code">C√≥digo de Producto (En DB Productos):</label>
                <input type="text" id="warehouse-code" placeholder="Ej: 9001">
            </div>
            <div class="form-inline">
                <label for="warehouse-qty">Existencia (Uds):</label>
                <input type="number" id="warehouse-qty" step="1" min="0" placeholder="Ej: 150">
                <button id="add-warehouse-button" class="success">A√±adir / Actualizar Existencia</button>
            </div>
            <hr style="margin: 20px 0;">
            <button id="export-warehouse-button" class="secondary">Exportar Inventario (CSV)</button>
            <button id="toggle-csv-warehouse-button" class="secondary">Importar CSV (Actualizaci√≥n Masiva)</button>
            <div id="csv-paste-warehouse-area" style="display: none; margin-top: 15px;">
                <label for="csv-warehouse-input">Pega aqu√≠ el Inventario de Cierre (Formato: `C√≥digo,Cantidad`):</label>
                <textarea id="csv-warehouse-input" placeholder="9001,150&#10;9003,50"></textarea>
                <button id="import-csv-warehouse-button" class="success">Importar Inventario</button>
            </div>
            <hr style="margin: 20px 0;"><h3>Inventario Actual</h3>
            <input type="text" id="search-warehouse" placeholder="Buscar producto en almac√©n...">
            <div id="warehouse-db-list"></div>
            <button id="clear-warehouse-button" class="danger" style="margin-top: 15px;">Borrar TODO el Inventario</button>
        </div>

    </div>

    <div id="operator-mode">

        <div id="op-welcome-screen" class="operator-screen" style="display: flex;">
            <h2>Modo Operario</h2>
            <button id="op-start-journey-button" class="success">INICIAR JORNADA</button>
            <button id="op-start-inventory-button" class="secondary">INICIAR INVENTARIO DE CIERRE</button>
        </div>

        <div id="op-paste-plans-screen" class="operator-screen">
            <h2>Cargar Planes de Jornada</h2>
            <label for="op-paste-textarea">Pega aqu√≠ el texto de transferencia recibido:</label>
            <textarea id="op-paste-textarea"></textarea>
            <button id="op-load-plans-button">Cargar Planes</button>
        </div>

        <div id="op-truck-list-screen" class="operator-screen">
            <h2>Camiones Pendientes</h2>
            <div id="op-truck-list-container"></div>
            <h3>Jornada en Curso</h3>
            <button id="op-finish-journey-button" class="danger">FINALIZAR JORNADA</button>
        </div>

        <div id="op-truck-start-screen" class="operator-screen">
            <h2>Preparado para Cargar</h2>
            <h3 id="start-truck-name" style="font-size: 2rem; color: var(--color-primario);">CAMI√ìN X</h3>
            <button id="op-truck-start-button" class="success">EMPEZAR CARGA DE CAMI√ìN</button>
            <button id="op-truck-cancel-start-button" class="secondary">Volver a Lista</button>
        </div>

        <div id="op-truck-step-screen" class="operator-screen">
            <h2 id="step-counter">Paso X de Y</h2>
            <p id="step-instruction">Instrucci√≥n de carga...</p>
            <button id="operator-next-button" class="success">SIGUIENTE</button>
            <button id="operator-incident-button" class="danger">Grabar Incidencia</button>
            <button id="operator-abandon-button" class="secondary" style="margin-top: 40px;">Abandonar Carga (Volver a Lista)</button>
        </div>

        <div id="op-truck-report-screen" class="operator-screen">
            <h2>Informe de Cami√≥n Finalizado</h2>
            <pre id="report-content">Generando informe...</pre>
            <button id="operator-whatsapp-button" class="success">Enviar por WhatsApp</button>
            <button id="operator-email-button">Enviar por Email</button>
            <button id="op-truck-report-exit-button" class="secondary">Volver a Lista de Camiones</button>
        </div>

        <div id="op-journey-report-screen" class="operator-screen">
            <h2>Informe de Jornada Finalizado</h2>
            <pre id="journey-report-content">Generando informe de jornada...</pre>
            <button id="journey-whatsapp-button" class="success">Enviar por WhatsApp</button>
            <button id="journey-email-button">Enviar por Email</button>
            <button id="op-journey-report-exit-button" class="secondary">NUEVA JORNADA</button>
        </div>

        <div id="op-inventory-screen" class="operator-screen">
            <h2>Inventario de Cierre (Reporte)</h2>
            <div class="form-inline" style="max-width: 400px; width: 100%; margin-bottom: 20px;">
                <input type="text" id="op-inventory-code" placeholder="C√≥digo de Producto">
                <input type="number" id="op-inventory-qty" placeholder="Cantidad (Uds.)" step="1" min="0">
                <button id="op-add-inventory-item-button" class="success" style="margin-top: 0;">A√±adir</button>
            </div>
            <ul id="op-inventory-list" style="max-width: 400px; width: 100%; text-align: left; list-style: none; padding: 0;">
                <p style="color: #ccc; text-align: center;">A√∫n no hay productos en el inventario de cierre.</p>
            </ul>
            <button id="op-generate-inventory-report-button" class="success" style="margin-top: 40px;">Generar Reporte y Enviar</button>
            <button onclick="showOperatorScreen('op-welcome-screen')" class="secondary">Cancelar y Volver</button>
        </div>

        <div id="op-inventory-report-screen" class="operator-screen">
            <h2>Informe de Inventario Generado</h2>
            <pre id="inventory-report-content">Generando reporte...</pre>
            <button id="inventory-whatsapp-button" class="success">Enviar por WhatsApp</button>
            <button id="inventory-email-button">Enviar por Email</button>
            <button id="op-inventory-report-exit-button" class="secondary">Volver a Inicio</button>
        </div>


    </div>

    <button id="assistance-button" class="secondary" title="Solicitar Asistencia">?</button>

    <script>
        
        // ==============================================================================
        //  üîí NIVEL 1: PROTECCI√ìN PROVISIONAL CON CONTRASE√ëA (IMPLEMENTACI√ìN)
        //  ESTO DEBE SER REEMPLAZADO POR FIREBASE PARA UNA SEGURIDAD REAL
        // ==============================================================================
        
        // ‚ö†Ô∏è CAMBIA ESTA CLAVE por la que t√∫ quieras
        const CLAVE_PROVISIONAL_SECRETA = "MiClaveTemporal12345"; 

        function verificarAccesoProvisional() {
            let clave = prompt("üîê Introduzca la clave de acceso para usar el Gestor de Carga (Provisional):");
            
            if (clave !== CLAVE_PROVISIONAL_SECRETA) {
                // Bloquear completamente la aplicaci√≥n y el script
                document.body.innerHTML = '<h1 style="color: red; text-align: center; margin-top: 100px;">‚ùå Acceso Denegado. Clave Incorrecta.</h1>';
                
                // Detiene toda la ejecuci√≥n restante del script
                throw new Error("Acceso no autorizado."); 
            }
            // Si la clave es correcta, el script contin√∫a ejecut√°ndose
        }

        // LLAMADA A LA FUNCI√ìN DE VERIFICACI√ìN
        verificarAccesoProvisional(); 

        // ==============================================================================
        //  üöÄ INICIO DEL SCRIPT PRINCIPAL V18
        // ==============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTES DE ALMACENAMIENTO ---
            const PRODUCT_DB_KEY = 'productDB_v16';
            const TRUCK_DB_KEY = 'truckDB_v16';
            const WAREHOUSE_DB_KEY = 'warehouseDB_v16';

            // --- ELEMENTOS DEL DOM (GLOBAL) ---
            const toggleModeButton = document.getElementById('toggle-mode-button');
            const officeModeDiv = document.getElementById('office-mode');
            const operatorModeDiv = document.getElementById('operator-mode');
            const assistanceButton = document.getElementById('assistance-button');

            // --- ELEMENTOS DEL DOM (OFICINA) ---
            const pedidoInput = document.getElementById('pedido-input');
            const processButton = document.getElementById('process-button');
            const resultDiv = document.getElementById('result');
            const importNotificationDiv = document.getElementById('product-import-notification');
            const addProductButton = document.getElementById('add-product-button');
            const clearProductFormButton = document.getElementById('clear-product-form-button');
            const productCodeInput = document.getElementById('product-code');
            const productDescInput = document.getElementById('product-desc');
            const productVolumeInput = document.getElementById('product-volume');
            const productDbListDiv = document.getElementById('product-db-list');
            const clearProductsButton = document.getElementById('clear-products-button');
            const searchProductInput = document.getElementById('search-product');
            const exportProductsButton = document.getElementById('export-products-button');
            const toggleCsvButton = document.getElementById('toggle-csv-button');
            const csvPasteArea = document.getElementById('csv-paste-area');
            const csvInput = document.getElementById('csv-input');
            const importCsvButton = document.getElementById('import-csv-button');
            const addTruckButton = document.getElementById('add-truck-button');
            const truckNameInput = document.getElementById('truck-name');
            const truckCapacityInput = document.getElementById('truck-capacity');
            const truckDbListDiv = document.getElementById('truck-db-list');
            const clearTrucksButton = document.getElementById('clear-trucks-button');

            // --- ELEMENTOS DEL DOM (ALMAC√âN) ---
            const warehouseCodeInput = document.getElementById('warehouse-code');
            const warehouseQtyInput = document.getElementById('warehouse-qty');
            const addWarehouseButton = document.getElementById('add-warehouse-button');
            const warehouseDbListDiv = document.getElementById('warehouse-db-list');
            const clearWarehouseButton = document.getElementById('clear-warehouse-button');
            const searchWarehouseInput = document.getElementById('search-warehouse');
            const toggleCsvWarehouseButton = document.getElementById('toggle-csv-warehouse-button');
            const csvPasteWarehouseArea = document.getElementById('csv-paste-warehouse-area');
            const csvWarehouseInput = document.getElementById('csv-warehouse-input');
            const importCsvWarehouseButton = document.getElementById('import-csv-warehouse-button');
            const exportWarehouseButton = document.getElementById('export-warehouse-button');


            // --- Lote de Carga (Oficina) ---
            const preparedPlansContainer = document.getElementById('prepared-plans-container');
            const preparedPlansList = document.getElementById('prepared-plans-list');
            const generateTransferButton = document.getElementById('generate-transfer-button');
            const clearPlansButton = document.getElementById('clear-plans-button');
            const transferTextContainer = document.getElementById('transfer-text-container');
            const transferTextArea = document.getElementById('transfer-text-area');
            const copyTransferTextButton = document.getElementById('copy-transfer-text-button');

            // --- NUEVOS ELEMENTOS DEL DOM (V17/V18) ---
            const warehouseCheckoutContainer = document.getElementById('warehouse-checkout-container');
            const checkoutReportContent = document.getElementById('checkout-report-content');
            const shareCheckoutWhatsappButton = document.getElementById('share-checkout-whatsapp-button');

            // --- ELEMENTOS DEL DOM (OPERARIO) ---
            const opWelcomeScreen = document.getElementById('op-welcome-screen');
            const opStartJourneyButton = document.getElementById('op-start-journey-button');
            const opPastePlansScreen = document.getElementById('op-paste-plans-screen');
            const opPasteTextarea = document.getElementById('op-paste-textarea');
            const opLoadPlansButton = document.getElementById('op-load-plans-button');
            const opTruckListScreen = document.getElementById('op-truck-list-screen');
            const opTruckListContainer = document.getElementById('op-truck-list-container');
            const opFinishJourneyButton = document.getElementById('op-finish-journey-button');
            const opTruckStartScreen = document.getElementById('op-truck-start-screen');
            const startTruckName = document.getElementById('start-truck-name');
            const opTruckStartButton = document.getElementById('op-truck-start-button');
            const opTruckCancelStartButton = document.getElementById('op-truck-cancel-start-button');
            const opTruckStepScreen = document.getElementById('op-truck-step-screen');
            const stepCounter = document.getElementById('step-counter');
            const stepInstruction = document.getElementById('step-instruction');
            const operatorNextButton = document.getElementById('operator-next-button');
            const operatorIncidentButton = document.getElementById('operator-incident-button');
            const operatorAbandonButton = document.getElementById('operator-abandon-button');
            const opTruckReportScreen = document.getElementById('op-truck-report-screen');
            const reportContent = document.getElementById('report-content');
            const operatorWhatsappButton = document.getElementById('operator-whatsapp-button');
            const operatorEmailButton = document.getElementById('operator-email-button');
            const opTruckReportExitButton = document.getElementById('op-truck-report-exit-button');
            const opJourneyReportScreen = document.getElementById('op-journey-report-screen');
            const journeyReportContent = document.getElementById('journey-report-content');
            const journeyWhatsappButton = document.getElementById('journey-whatsapp-button');
            const journeyEmailButton = document.getElementById('journey-email-button');
            const opJourneyReportExitButton = document.getElementById('op-journey-report-exit-button');

            // --- ELEMENTOS DE INVENTARIO DE CIERRE (OPERARIO) ---
            const opStartInventoryButton = document.getElementById('op-start-inventory-button');
            const opInventoryScreen = document.getElementById('op-inventory-screen');
            const opInventoryList = document.getElementById('op-inventory-list');
            const opInventoryCodeInput = document.getElementById('op-inventory-code');
            const opInventoryQtyInput = document.getElementById('op-inventory-qty');
            const opAddInventoryItemButton = document.getElementById('op-add-inventory-item-button');
            const opGenerateInventoryReportButton = document.getElementById('op-generate-inventory-report-button');
            const opInventoryReportScreen = document.getElementById('op-inventory-report-screen');
            const inventoryReportContent = document.getElementById('inventory-report-content');
            const inventoryWhatsappButton = document.getElementById('inventory-whatsapp-button');
            const inventoryEmailButton = document.getElementById('inventory-email-button');
            const opInventoryReportExitButton = document.getElementById('op-inventory-report-exit-button');
            let currentInventory = {}; // Almacenamiento temporal de inventario del Operario


            // --- BASES DE DATOS ---
            let productDB = JSON.parse(localStorage.getItem(PRODUCT_DB_KEY)) || {};
            let truckDB = JSON.parse(localStorage.getItem(TRUCK_DB_KEY)) || {};
            let warehouseDB = JSON.parse(localStorage.getItem(WAREHOUSE_DB_KEY)) || {};

            // --- ESTADO GLOBAL ---
            let preparedPlans = [];
            let journeyStartTime = null;
            let allJourneyIncidents = [];
            let operatorTrucksPending = [];
            let operatorTrucksCompleted = [];

            // --- ESTADO DE CARGA (Operario, para 1 cami√≥n) ---
            let currentLoadList = [];
            let currentTruckName = '';
            let currentStep = 0;
            let loadStartTime = null;
            let loadIncidents = [];

            // --- APIs DE VOZ ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES'; recognition.continuous = false; recognition.interimResults = false;
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const time = formatTime(new Date());
                    const stepText = currentLoadList[currentStep]?.desc || 'General';
                    const incidentText = `${time} - Paso ${currentStep + 1} (${stepText}): "${transcript}"`;
                    loadIncidents.push(incidentText);
                    alert(`Incidencia registrada: "${transcript}"`);
                };
                recognition.onerror = (event) => alert('Error de micr√≥fono: ' + event.error);
                recognition.onend = () => {
                    operatorIncidentButton.textContent = 'Grabar Incidencia';
                    operatorIncidentButton.classList.remove('listening');
                    operatorIncidentButton.disabled = false;
                };
            }

            // --- L√ìGICA DE PESTA√ëAS (OFICINA) ---
            window.openTab = (tabName, elmnt) => {
                let i, tabcontent, tablinks;
                tabcontent = elmnt.closest('.container').getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
                tablinks = elmnt.closest('.container').getElementsByClassName("tab-button");
                for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
                document.getElementById(tabName).style.display = "block";
                elmnt.className += " active";
                if(tabName === 'tab-view-products') {
                    // Mueve la tarea potencialmente pesada (renderizado) a la cola de eventos
                    setTimeout(renderProductList, 0); 
                }
            }

            // --- GESTI√ìN DE PRODUCTOS (OFICINA) ---
            const saveProducts = () => localStorage.setItem(PRODUCT_DB_KEY, JSON.stringify(productDB));
            const clearProductForm = () => {
                productCodeInput.value = ''; productDescInput.value = ''; productVolumeInput.value = '';
                productCodeInput.disabled = false;
            };
            const addProduct = () => {
                const code = productCodeInput.value.trim(); const desc = productDescInput.value.trim();
                const volume = parseFloat(productVolumeInput.value);
                if (!code) { alert('El C√≥digo es obligatorio.'); return; }
                if (!desc) { alert('La Descripci√≥n es obligatoria.'); return; }
                if (isNaN(volume) || volume < 0) { alert('El Volumen debe ser un n√∫mero positivo.'); return; }

                productDB[code] = { desc, volume };
                saveProducts(); clearProductForm();

                // üåü MITIGACI√ìN DE RENDIMIENTO: Usamos setTimeout(..., 0) para liberar el hilo principal.
                // La alerta se mostrar√° de inmediato, y el renderizado (tarea pesada) se har√° despu√©s.
                setTimeout(() => {
                    if (document.getElementById('tab-view-products').classList.contains('active')) {
                        searchProductInput.value = code;
                        renderProductList();
                    }
                }, 0);

                alert(`Producto ${code} guardado/actualizado.`);
            };
            window.editProduct = (code) => {
                const product = productDB[code];
                if (product) {
                    productCodeInput.value = code; productDescInput.value = product.desc; productVolumeInput.value = product.volume;
                    productCodeInput.disabled = true;
                    const addTabButton = document.querySelector('#product-manager .tab-button[onclick*="tab-add-product"]');
                    openTab('tab-add-product', addTabButton);
                }
            };
            window.deleteProduct = (code) => {
                if (confirm(`¬øEliminar producto ${code}?`)) {
                    delete productDB[code];
                    delete warehouseDB[code];
                    saveProducts();
                    saveWarehouse();
                    setTimeout(renderProductList, 0);
                    setTimeout(renderWarehouseList, 0);
                }
            };
            const renderProductList = () => {
                productDbListDiv.innerHTML = ''; const filter = searchProductInput.value.toLowerCase();
                const sortedCodes = Object.keys(productDB).sort();
                if (sortedCodes.length === 0) { productDbListDiv.innerHTML = '<p>No hay productos.</p>'; return; }
                let visibleCount = 0;
                sortedCodes.forEach(code => {
                    const product = productDB[code]; const productString = `${code} ${product.desc}`.toLowerCase();
                    if (productString.includes(filter)) {
                        visibleCount++; const item = document.createElement('div'); item.className = 'db-item';
                        item.innerHTML = `
                            <span><strong>${code}</strong></span><span class="db-item-desc">${product.desc}</span>
                            <span>${product.volume.toFixed(6)} m¬≥</span>
                            <div><button onclick="editProduct('${code}')" class="secondary">Editar</button>
                                 <button onclick="deleteProduct('${code}')" class="danger">X</button></div>`;
                        productDbListDiv.appendChild(item);
                    }
                });
                if (visibleCount === 0) { productDbListDiv.innerHTML = '<p>No se encontraron productos.</p>'; }
            };
            const clearAllProducts = () => {
                if (confirm('¬øBORRAR TODOS los productos? ESTO TAMBI√âN BORRAR√Å EL INVENTARIO ASOCIADO.')) {
                    productDB = {}; saveProducts(); setTimeout(renderProductList, 0);
                    warehouseDB = {}; saveWarehouse(); setTimeout(renderWarehouseList, 0);
                }
            };
            const exportProducts = () => {
                let csvContent = "data:text/csv;charset=utf-8,Codigo,Descripcion,Volumen\n";
                Object.keys(productDB).sort().forEach(code => {
                    const p = productDB[code]; csvContent += `${code},"${p.desc.replace(/"/g, '""')}",${p.volume}\n`;
                });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "productos_carga_v18.csv"); document.body.appendChild(link);
                link.click(); document.body.removeChild(link);
            };
            const toggleCsvImport = () => {
                csvPasteArea.style.display = (csvPasteArea.style.display === 'none' || csvPasteArea.style.display === '') ? 'block' : 'none';
                toggleCsvButton.textContent = csvPasteArea.style.display === 'block' ? 'Ocultar Importaci√≥n (CSV)' : 'Importar Lista (CSV)';
            };
            const importCsvProducts = () => {
                const text = csvInput.value.trim(); if (!text) return;
                const lines = text.split('\n'); let importedCount = 0, errorCount = 0;
                lines.forEach(line => {
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    if (parts && parts.length === 3) {
                        try {
                            const code = parts[0].trim().replace(/"/g, ''); const desc = parts[1].trim().replace(/"/g, '');
                            const volume = parseFloat(parts[2].trim().replace(/"/g, ''));
                            if (code && desc && !isNaN(volume) && volume >= 0) {
                                productDB[code] = { desc, volume }; importedCount++;
                            } else { errorCount++; }
                        } catch (e) { errorCount++; }
                    } else if (line.trim() !== "" && !line.startsWith("Codigo")) { errorCount++; }
                });

                if (importedCount > 0) {
                    saveProducts(); alert(`Importaci√≥n: ${importedCount} productos a√±adidos/actualizados.`);
                    csvInput.value = ''; toggleCsvImport();

                    setTimeout(() => {
                        if (document.getElementById('tab-view-products').style.display === 'block') {
                             const viewTabButton = document.querySelector('#product-manager .tab-button[onclick*="tab-view-products"]');
                             openTab('tab-view-products', viewTabButton);
                             searchProductInput.value = ''; renderProductList();
                        }
                    }, 0);
                }
                if (errorCount > 0) { alert(`${errorCount} l√≠neas no pudieron ser procesadas.`); }
            };

            // --- GESTI√ìN DE CAMIONES (OFICINA) ---
            const saveTrucks = () => localStorage.setItem(TRUCK_DB_KEY, JSON.stringify(truckDB));
            const addTruck = () => {
                const name = truckNameInput.value.trim(); const capacity = parseFloat(truckCapacityInput.value);
                if (!name) { alert('El Nombre es obligatorio.'); return; }
                if (isNaN(capacity) || capacity <= 0) { alert('La Capacidad debe ser un n√∫mero positivo.'); return; }

                truckDB[name] = { capacity }; saveTrucks();
                truckNameInput.value = ''; truckCapacityInput.value = '';

                setTimeout(renderTruckList, 0);

                alert(`Cami√≥n ${name} guardado/actualizado.`);
            };
            window.editTruck = (name) => {
                const truck = truckDB[name];
                if (truck) { truckNameInput.value = name; truckCapacityInput.value = truck.capacity; }
            };
            window.deleteTruck = (name) => {
                if (confirm(`¬øEliminar cami√≥n ${name}?`)) {
                    delete truckDB[name]; saveTrucks(); setTimeout(renderTruckList, 0);
                }
            };
            const renderTruckList = () => {
                truckDbListDiv.innerHTML = ''; const truckNames = Object.keys(truckDB).sort();
                if (truckNames.length === 0) { truckDbListDiv.innerHTML = '<p>No hay camiones.</p>'; return; }
                truckNames.forEach(name => {
                    const truck = truckDB[name]; const item = document.createElement('div'); item.className = 'db-item';
                    item.innerHTML = `
                        <span class="db-item-desc"><strong>${name}</strong></span>
                        <span>${truck.capacity.toFixed(2)} m¬≥</span>
                        <div><button onclick="editTruck('${name}')" class="secondary">Editar</button>
                             <button onclick="deleteTruck('${name}')" class="danger">X</button></div>`;
                    truckDbListDiv.appendChild(item);
                });
            };
            const clearAllTrucks = () => {
                if (confirm('¬øBORRAR TODOS los camiones?')) {
                    truckDB = {}; saveTrucks(); setTimeout(renderTruckList, 0);
                }
            };

            // --- GESTI√ìN DE ALMAC√âN ---
            const saveWarehouse = () => localStorage.setItem(WAREHOUSE_DB_KEY, JSON.stringify(warehouseDB));

            const addWarehouseProduct = () => {
                const code = warehouseCodeInput.value.trim();
                const qty = parseInt(warehouseQtyInput.value);

                if (!code) { alert('El C√≥digo de Producto es obligatorio.'); return; }
                if (isNaN(qty) || qty < 0) { alert('La Existencia debe ser un n√∫mero entero positivo.'); return; }
                if (!productDB[code]) { alert(`Error: El c√≥digo ${code} no existe en la Base de Datos de Productos.`); return; }

                warehouseDB[code] = { qty, desc: productDB[code].desc };
                saveWarehouse();
                warehouseCodeInput.value = '';
                warehouseQtyInput.value = '';

                setTimeout(renderWarehouseList, 0);
                alert(`Stock de ${code} actualizado a ${qty} uds.`);
            };

            window.editWarehouse = (code) => {
                const item = warehouseDB[code];
                if (item) {
                    warehouseCodeInput.value = code;
                    warehouseQtyInput.value = item.qty;
                }
            };

            window.deleteWarehouseItem = (code) => {
                if (confirm(`¬øEliminar el stock del producto ${code} del almac√©n?`)) {
                    delete warehouseDB[code];
                    saveWarehouse();
                    setTimeout(renderWarehouseList, 0);
                }
            };

            const renderWarehouseList = () => {
                warehouseDbListDiv.innerHTML = '';
                const filter = searchWarehouseInput.value.toLowerCase();
                const sortedCodes = Object.keys(warehouseDB).sort();

                if (sortedCodes.length === 0) { warehouseDbListDiv.innerHTML = '<p>El almac√©n est√° vac√≠o.</p>'; return; }

                let visibleCount = 0;
                sortedCodes.forEach(code => {
                    const item = warehouseDB[code];
                    const itemString = `${code} ${item.desc}`.toLowerCase();
                    if (itemString.includes(filter)) {
                        visibleCount++;
                        const element = document.createElement('div');
                        element.className = 'db-item';
                        element.innerHTML = `
                            <span><strong>${code}</strong></span>
                            <span class="db-item-desc">${item.desc}</span>
                            <span>**${item.qty} uds.**</span>
                            <div>
                                <button onclick="editWarehouse('${code}')" class="secondary">Editar</button>
                                <button onclick="deleteWarehouseItem('${code}')" class="danger">X</button>
                            </div>
                        `;
                        warehouseDbListDiv.appendChild(element);
                    }
                });
                if (visibleCount === 0) { warehouseDbListDiv.innerHTML = '<p>No se encontraron productos en el almac√©n.</p>'; }
            };

            const clearAllWarehouse = () => {
                if (confirm('¬øBORRAR TODO el inventario del Almac√©n Propio?')) {
                    warehouseDB = {};
                    saveWarehouse();
                    setTimeout(renderWarehouseList, 0);
                }
            };

            // --- NUEVA L√ìGICA DE EXPORTACI√ìN/IMPORTACI√ìN DE ALMAC√âN (Inventario de Cierre) ---
            const toggleCsvWarehouseImport = () => {
                csvPasteWarehouseArea.style.display = (csvPasteWarehouseArea.style.display === 'none' || csvPasteWarehouseArea.style.display === '') ? 'block' : 'none';
                toggleCsvWarehouseButton.textContent = csvPasteWarehouseArea.style.display === 'block' ? 'Ocultar Importaci√≥n (CSV)' : 'Importar CSV (Actualizaci√≥n Masiva)';
            };

            const importCsvWarehouse = () => {
                const text = csvWarehouseInput.value.trim(); if (!text) return;
                const lines = text.split('\n'); let updatedCount = 0, errorCount = 0;
                let isFirstLine = true; // Para ignorar el encabezado 'Codigo,Cantidad'

                lines.forEach(line => {
                    if (isFirstLine) { isFirstLine = false; return; } // Ignorar encabezado
                    
                    // Formato esperado: Codigo,Cantidad
                    const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
                    if (parts && parts.length === 2) {
                        try {
                            const code = parts[0];
                            const qty = parseInt(parts[1]);

                            if (productDB[code] && !isNaN(qty) && qty >= 0) {
                                warehouseDB[code] = { qty, desc: productDB[code].desc };
                                if (qty === 0) delete warehouseDB[code]; // Eliminar si el stock es cero
                                updatedCount++;
                            } else { errorCount++; }
                        } catch (e) { errorCount++; }
                    } else if (line.trim() !== "") { errorCount++; }
                });

                if (updatedCount > 0) {
                    saveWarehouse(); alert(`Inventario Actualizado: ${updatedCount} productos actualizados/a√±adidos.`);
                    csvWarehouseInput.value = ''; toggleCsvWarehouseImport();
                    setTimeout(renderWarehouseList, 0);
                }
                if (errorCount > 0) { alert(`${errorCount} l√≠neas no pudieron ser procesadas. Confirma que el formato es 'C√ìDIGO,CANTIDAD' y que el producto existe en la DB de Productos.`); }
            };

            const exportWarehouse = () => {
                let csvContent = "data:text/csv;charset=utf-8,Codigo,Existencia\n"; // Formato simple para la reimportaci√≥n
                Object.keys(warehouseDB).sort().forEach(code => {
                    const w = warehouseDB[code]; csvContent += `${code},${w.qty}\n`;
                });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "inventario_almacen_v18.csv"); document.body.appendChild(link);
                link.click(); document.body.removeChild(link);
            };
            // --- FIN NUEVA L√ìGICA DE ALMAC√âN ---

            // --- PROCESADOR DE PEDIDOS (OFICINA) - L√ìGICA V18 ---

            const parsePedido = (text) => {
                const lines = text.split('\n');
                const products = new Map();
                let truckName = null;
                const truckRegex = /Cami√≥n:\s*(.+)/i;

                const productRegexComma = /^\s*(\d+(\.\d+)?|\d+\.\d+\s+\d{4,})\s*,\s*(\s*\S+)\s*(.+)$/;
                const productRegexNoQty = /^\s*(\d{4,})\s+(.+)$/;
                const productRegexQtyCode = /^\s*(\d+(\.\d+)?|\d+\.\d+)\s+(\d{4,})\s*(.+)$/;

                lines.forEach(line => {
                    let match;

                    match = line.match(truckRegex);
                    if (match) {
                        truckName = match[1].trim();
                        return;
                    }

                    let qty = 0;
                    let code = null;
                    let desc = null;

                    match = line.match(productRegexComma);
                    if (match) {
                        let qtyPart = match[1].trim();
                        let descPart = match[4].trim();

                        if (!isNaN(parseFloat(qtyPart))) {
                            qty = parseFloat(qtyPart);
                            const codeMatch = descPart.match(/^(\d{4,})\s*(.*)$/);
                            if (codeMatch) {
                                code = codeMatch[1].trim();
                                desc = codeMatch[2].trim();
                            }
                        }
                    }

                    if (!code) {
                        match = line.match(productRegexQtyCode);
                        if (match) {
                            qty = parseFloat(match[1]);
                            code = match[3].trim();
                            desc = match[4].trim();
                        }
                    }

                    if (!code) {
                        match = line.match(productRegexNoQty);
                        if (match) {
                            code = match[1].trim();
                            desc = match[2].trim();
                            qty = 1.0;
                        }
                    }

                    // Intento de Regex Full si las anteriores fallan (Simplificado para evitar duplicados complejos)
                    if (!code) {
                        const productRegexFull = /^\s*(\d+(\.\d+)?|\d+\.\d+\s+\d{4,})\s+-\s+(.+)$/;
                        match = line.match(productRegexFull);
                        if (match) {
                            qty = parseFloat(match[1]);
                            const codeDescPart = match[3].trim();
                            const codeMatch = codeDescPart.match(/^(\d{4,})\s*(.*)$/);
                             if(codeMatch) {
                                code = codeMatch[1].trim();
                                desc = codeMatch[2].trim();
                            }
                        }
                    }


                    if (qty > 0 && code && desc && !desc.toLowerCase().startsWith('total')) {
                        code = code.match(/\d+/)?.[0] || code;
                        desc = desc.replace(/,$/, '').trim();

                        products.set(code, {
                            qty: (products.get(code)?.qty || 0) + qty,
                            desc: products.get(code)?.desc || desc
                        });
                    }
                });
                return { products, truckName };
            };

            const processPedido = () => {
                const text = pedidoInput.value;
                if (!text.trim()) { resultDiv.innerHTML = 'El √°rea del pedido est√° vac√≠a.'; resultDiv.className = 'error'; return; }
                const { products, truckName } = parsePedido(text);

                // 1. Verificaci√≥n Inicial
                if (!truckName) { resultDiv.innerHTML = `<strong>Error: No se pudo detectar el nombre del cami√≥n.</strong>`; resultDiv.className = 'error'; importNotificationDiv.style.display = 'none'; return; }
                const truck = truckDB[truckName];
                if (!truck) { resultDiv.innerHTML = `<strong>Error: Cami√≥n "${truckName}" no encontrado.</strong>`; resultDiv.className = 'error'; importNotificationDiv.style.display = 'none'; return; }
                if (products.size === 0) { resultDiv.innerHTML = `<strong>Error: No se encontraron productos.</strong>`; resultDiv.className = 'error'; importNotificationDiv.style.display = 'none'; return; }
                if (preparedPlans.find(p => p.truckName === truckName)) { resultDiv.innerHTML = `<strong>Error: El cami√≥n "${truckName}" ya est√° en el lote de carga.</strong><br>Limpia el lote si quieres empezar de nuevo.`; resultDiv.className = 'error'; return; }

                let productListForLoading = [];
                let importedProducts = [];
                let productsToCheckout = [];

                const DEFAULT_VOLUME = 0.0001;
                let totalVolume = 0;

                products.forEach((data, code) => {
                    const productData = productDB[code];
                    const requiredQtyTotal = data.qty;
                    let availableQtyPropio = warehouseDB[code]?.qty || 0;

                    let itemVolume = DEFAULT_VOLUME;
                    let itemDesc = data.desc;

                    // A. Revisar existencia del producto en la DB de Productos (y a√±adir si es nuevo)
                    if (!productData) {
                        productDB[code] = { desc: data.desc, volume: DEFAULT_VOLUME };
                        importedProducts.push(code);
                    } else {
                        itemVolume = productData.volume; itemDesc = productData.desc;
                    }

                    // --- B. L√ìGICA DE SUMINISTRO COMPUESTO (V18) ---

                    // Cantidad a retirar del Almac√©n Propio: M√≠nimo entre lo requerido y lo disponible.
                    const qtyFromPropio = Math.min(requiredQtyTotal, availableQtyPropio);

                    // Cantidad a retirar del Almac√©n General: Lo que falta para completar el pedido (asumimos que siempre est√° disponible).
                    const qtyFromGeneral = requiredQtyTotal - qtyFromPropio;

                    // C. Preparar lista de productos para el checkout (retiro f√≠sico)
                    if (qtyFromPropio > 0) {
                        productsToCheckout.push({ code, desc: itemDesc, qty: qtyFromPropio });
                    }

                    // D. El producto para la carga es la CANTIDAD TOTAL del pedido.
                    productListForLoading.push({
                        code,
                        desc: itemDesc,
                        qty: requiredQtyTotal,
                        totalVolume: requiredQtyTotal * itemVolume,
                        qtyPropio: qtyFromPropio,
                        qtyGeneral: qtyFromGeneral
                    });

                    totalVolume += requiredQtyTotal * itemVolume;
                });

                // --- 2. RESTA DE STOCK (CHECKOUT INMEDIATO) Y GENERACI√ìN DE INFORME ---

                let checkoutReport = `--- RETIRO DE ALMAC√âN PROPIO ---\n\n`;
                checkoutReport += `Pedido para Cami√≥n: ${truckName}\n`;
                checkoutReport += `Capacidad del Cami√≥n: ${truck.capacity.toFixed(2)} m¬≥\n`;

                if (productsToCheckout.length > 0) {
                    // Resta del Inventario Propio
                    productsToCheckout.forEach(item => {
                         if (warehouseDB[item.code]) {
                             warehouseDB[item.code].qty -= item.qty;
                             if (warehouseDB[item.code].qty <= 0) {
                                 delete warehouseDB[item.code];
                             } else {
                                warehouseDB[item.code].desc = productDB[item.code].desc;
                             }
                         }
                    });
                    saveWarehouse();
                    setTimeout(renderWarehouseList, 0);

                    checkoutReport += `\nCANTIDAD A RETIRAR | C√ìDIGO | DESCRIPCI√ìN\n`;
                    checkoutReport += `-------------------------------------------\n`;
                    productsToCheckout.forEach(item => {
                        checkoutReport += `${item.qty.toFixed(1).padEnd(19)} | ${item.code.padEnd(6)} | ${item.desc}\n`;
                    });
                    warehouseCheckoutContainer.style.display = 'block';
                } else {
                    checkoutReport += `\nLa carga no requiere extracci√≥n de Stock Propio.`;
                    warehouseCheckoutContainer.style.display = 'block'; // Mostrar siempre el aviso, incluso si no hay nada que retirar.
                }

                checkoutReportContent.textContent = checkoutReport;
                shareCheckoutWhatsappButton.onclick = () => shareReport('whatsapp', checkoutReport, `Aviso de Retiro - ${truckName}`);

                // --- 3. VERIFICACI√ìN DE CAPACIDAD (Punto de fallo final) ---
                productListForLoading.sort((a, b) => b.totalVolume - a.totalVolume);
                const remainingCapacity = truck.capacity - totalVolume;

                let resultHTML = `<h3>Resultados para: ${truckName} (Cap: ${truck.capacity.toFixed(2)} m¬≥)</h3>`;

                if (remainingCapacity < 0) {
                    resultDiv.className = 'error';
                    resultHTML += `<h2><span style="font-size: 2.5rem;">‚ùå</span> ¬°LA CARGA NO CABE!</h2>`;
                    resultHTML += `<p>El volumen total del pedido (${totalVolume.toFixed(4)} m¬≥) excede la capacidad del cami√≥n.</p>`;
                    resultHTML += `<p><strong>Volumen Excedido: ${Math.abs(remainingCapacity).toFixed(4)} m¬≥</strong></p>`;

                    // ADVERTENCIA DE REVERSI√ìN DE STOCK
                    resultHTML += `<p style="color:red; font-weight:bold;">¬°ADVERTENCIA! El stock Propio ya fue restado. Si el pedido es cancelado o modificado, debe reingresar manualmente la cantidad en la secci√≥n 4: ${productsToCheckout.length} productos afectados.</p>`;

                    resultDiv.innerHTML = resultHTML;
                    pedidoInput.value = '';
                    if (importedProducts.length > 0) { saveProducts(); importNotificationDiv.innerHTML = `<strong>¬°Productos Importados!</strong><br>Se han a√±adido ${importedProducts.length} productos nuevos. <strong>Acci√≥n Requerida:</strong> Actualiza sus vol√∫menes.`; importNotificationDiv.style.display = 'block'; }
                    return; // DETIENE EL PROCESO
                }

                // --- 4. √âXITO (A√±adir al Lote) ---
                resultDiv.className = 'success';
                resultHTML += `<h2><span style="font-size: 2.5rem;">‚úÖ</span> ¬°A√ëADIDO AL LOTE!</h2>`;
                resultHTML += `<p><strong>Cami√≥n: ${truckName}</strong> | <strong>Volumen Total: ${totalVolume.toFixed(4)} m¬≥</strong></p>`;

                // 4.1. GUARDAR PLAN
                const newPlan = { truckName, loadList: productListForLoading };
                preparedPlans.push(newPlan);

                // 4.2. NOTIFICACI√ìN DE IMPORTACI√ìN DE PRODUCTOS
                if (importedProducts.length > 0) {
                    saveProducts();
                    importNotificationDiv.innerHTML = `<strong>¬°Productos Importados!</strong><br>Se han a√±adido ${importedProducts.length} productos nuevos. <strong>Acci√≥n Requerida:</strong> Actualiza sus vol√∫menes.`;
                    importNotificationDiv.style.display = 'block';
                    setTimeout(() => { if (document.getElementById('tab-view-products').style.display === 'block') { renderProductList(); } }, 0);
                } else { importNotificationDiv.style.display = 'none'; }


                resultHTML += '<h3>Orden de Carga Sugerido:</h3><ol id="load-order-list">';
                productListForLoading.forEach(item => {
                    resultHTML += `<li><strong>${item.qty.toFixed(1)} uds</strong> - ${item.code} (Propio: ${item.qtyPropio.toFixed(1)} / General: ${item.qtyGeneral.toFixed(1)})</li>`;
                });
                resultHTML += '</ol>';

                resultDiv.innerHTML = resultHTML;
                renderPreparedPlansList();
                pedidoInput.value = ''; // Limpiar el input despu√©s de procesar
            };

            // --- L√≥gica de Lotes (Oficina) ---
            const renderPreparedPlansList = () => {
                if (preparedPlans.length === 0) {
                    preparedPlansContainer.style.display = 'none';
                    return;
                }
                preparedPlansContainer.style.display = 'block';
                transferTextContainer.style.display = 'none';
                preparedPlansList.innerHTML = '';
                preparedPlans.forEach(plan => {
                    const li = document.createElement('li');
                    li.textContent = `${plan.truckName} (${plan.loadList.length} pasos)`;
                    preparedPlansList.appendChild(li);
                });
            };

            const generateTransferText = () => {
                if (preparedPlans.length === 0) {
                    alert('No hay planes en el lote para generar.'); return;
                }
                try {
                    const dataString = JSON.stringify(preparedPlans);
                    const encodedData = btoa(dataString);
                    transferTextContainer.style.display = 'block';
                    transferTextArea.value = encodedData;
                } catch (e) {
                    alert('Error al generar el texto de transferencia: ' + e.message);
                }
            };

            const copyTransferText = () => {
                transferTextArea.select();
                document.execCommand('copy');
                alert('¬°Texto copiado al portapapeles!');
            };

            const clearPreparedPlans = () => {
                if (confirm('¬øLimpiar el lote de camiones preparados?')) {
                    preparedPlans = [];
                    renderPreparedPlansList();
                    resultDiv.innerHTML = 'Lote de carga limpiado. Listo para procesar nuevos pedidos.';
                    resultDiv.className = '';
                    transferTextContainer.style.display = 'none';
                    importNotificationDiv.style.display = 'none';
                    warehouseCheckoutContainer.style.display = 'none'; // Ocultar el aviso de checkout al limpiar el lote
                }
            };

            // --- L√ìGICA DE CAMBIO DE MODO Y ASISTENCIA (Global) ---
            const showOfficeMode = () => {
                operatorModeDiv.style.display = 'none';
                officeModeDiv.style.display = 'grid';
                toggleModeButton.textContent = 'Cambiar a Modo Operario';
                document.body.style.backgroundColor = 'var(--color-fondo)';
            };

            const showOperatorMode = () => {
                officeModeDiv.style.display = 'none';
                operatorModeDiv.style.display = 'block';
                showOperatorScreen('op-welcome-screen');
                toggleModeButton.textContent = 'Volver a Modo Oficina';
                document.body.style.backgroundColor = '#2c3e50';
            };

            toggleModeButton.addEventListener('click', () => {
                if (officeModeDiv.style.display === 'grid') {
                    showOperatorMode();
                } else {
                    if (journeyStartTime === null || confirm('¬øSalir del Modo Operario? Se perder√° el progreso de la jornada.')) {
                        showOfficeMode();
                    }
                }
            });

            assistanceButton.addEventListener('click', () => {
                const phone = '+34643734158';
                const problem = prompt('Por favor, describe brevemente tu problema de asistencia (WhatsApp):');

                if (problem) {
                    const message = `¬°Hola! Necesito asistencia con la app Gestor de Carga (v18).\n\nProblema: ${problem}`;
                    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                    window.open(url, '_blank');
                }
            });

            // --- L√ìGICA MODO OPERARIO ---

            const showOperatorScreenImpl = (screenId) => {
                document.querySelectorAll('.operator-screen').forEach(s => s.style.display = 'none');
                document.getElementById(screenId).style.display = 'flex';
            };
            window.showOperatorScreen = showOperatorScreenImpl;

            window.formatTime = (date) => date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            window.speak = (text) => {
                if (!('speechSynthesis' in window)) { return; }
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            };

            window.startJourney = () => {
                journeyStartTime = new Date();
                allJourneyIncidents = [];
                operatorTrucksCompleted = [];
                operatorTrucksPending = [];
                opPasteTextarea.value = '';
                showOperatorScreen('op-paste-plans-screen');
            };

            window.loadPlansFromText = () => {
                const text = opPasteTextarea.value.trim().replace(/\s/g, '');
                if (!text) { alert('El √°rea de texto est√° vac√≠a.'); return; }
                try {
                    if (!/^[A-Za-z0-9+/=]+$/.test(text)) {
                         throw new Error('El texto contiene caracteres inv√°lidos para Base64.');
                    }
                    const decodedString = atob(text);
                    operatorTrucksPending = JSON.parse(decodedString);
                    if (!Array.isArray(operatorTrucksPending) || operatorTrucksPending.length === 0) {
                        throw new Error('No se encontraron planes v√°lidos o el formato es incorrecto.');
                    }
                    renderOperatorTruckList();
                    showOperatorScreen('op-truck-list-screen');
                    speak('Planes de carga cargados. Listos para empezar.');
                } catch (e) {
                    console.error("Fallo de Carga de Planes:", e);
                    alert(`Error al cargar los planes. Confirme que copi√≥ el texto COMPLETO sin modificar. \n\nDetalle del fallo: ${e.message}`);
                }
            };

            window.renderOperatorTruckList = () => {
                opTruckListContainer.innerHTML = '';
                if (operatorTrucksPending.length === 0) {
                    opTruckListContainer.innerHTML = '<p>¬°No quedan camiones pendientes!</p>';
                    opFinishJourneyButton.style.display = 'block';
                } else {
                    operatorTrucksPending.forEach(plan => {
                        const button = document.createElement('button');
                        button.textContent = `Cargar ${plan.truckName} (${plan.loadList.length} pasos)`;
                        button.className = 'truck-button';
                        button.onclick = () => selectTruckToLoad(plan.truckName);
                        opTruckListContainer.appendChild(button);
                    });
                    opFinishJourneyButton.style.display = 'none';
                }
            };

            window.selectTruckToLoad = (truckName) => {
                const plan = operatorTrucksPending.find(p => p.truckName === truckName);
                currentLoadList = plan.loadList;
                currentTruckName = plan.truckName;
                startTruckName.textContent = currentTruckName;
                showOperatorScreen('op-truck-start-screen');
            };

            window.startTruckLoad = () => {
                loadStartTime = new Date();
                loadIncidents = [];
                currentStep = 0;
                showOperatorScreen('op-truck-step-screen');
                showStep(0);
            };

            window.showStep = (index) => {
                if (index >= currentLoadList.length) {
                    finishTruckLoad(); return;
                }
                const item = currentLoadList[index];

                // NOTA: La instrucci√≥n ahora es m√°s detallada
                let instruction = `Cargar ${item.qty.toFixed(1)} uds - ${item.code} (${item.desc})`;
                if (item.qtyPropio > 0) {
                     instruction += ` (Recuerda que ${item.qtyPropio.toFixed(1)} uds. vienen del ALMAC√âN PROPIO)`;
                }

                stepCounter.textContent = `Paso ${index + 1} de ${currentLoadList.length}`;
                stepInstruction.textContent = instruction;
                operatorNextButton.textContent = (index === currentLoadList.length - 1) ? 'FINALIZAR CARGA' : 'SIGUIENTE';
                speak(instruction);
            };

            window.recordIncident = () => {
                if (!SpeechRecognition) {
                    const incident = prompt('Navegador no compatible. Escribe la incidencia:');
                    if (incident) {
                        const time = formatTime(new Date());
                        const stepText = currentLoadList[currentStep]?.desc || 'General';
                        const incidentText = `${time} - Paso ${currentStep + 1} (${stepText}): "${incident}"`;
                        loadIncidents.push(incidentText);
                        alert('Incidencia registrada.');
                    }
                    return;
                }
                try {
                    operatorIncidentButton.textContent = '... Escuchando ...';
                    operatorIncidentButton.classList.add('listening'); operatorIncidentButton.disabled = true;
                    recognition.start();
                } catch (e) {
                    alert('Error al iniciar el micr√≥fono. ¬øDiste permiso?');
                    operatorIncidentButton.textContent = 'Grabar Incidencia';
                    operatorIncidentButton.classList.remove('listening'); operatorIncidentButton.disabled = false;
                }
            };

            window.finishTruckLoad = () => {
                const endTime = new Date();
                const totalTimeMin = Math.round((endTime - loadStartTime) / 60000);

                let report = `--- INFORME DE CAMI√ìN ---\n\n`;
                report += `Cami√≥n: ${currentTruckName}\nFecha: ${endTime.toLocaleDateString('es-ES')}\n`;
                report += `Hora Inicio Carga: ${formatTime(loadStartTime)}\nHora Fin Carga: ${formatTime(endTime)}\n`;
                report += `Tiempo Total: ${totalTimeMin} minutos\n\n`;

                if (loadIncidents.length > 0) {
                    report += `--- INCIDENCIAS (${loadIncidents.length}) ---\n`;
                    loadIncidents.forEach(inc => { report += `- ${inc}\n`; });
                    allJourneyIncidents.push(...loadIncidents);
                } else {
                    report += `--- SIN INCIDENCIAS ---`;
                }

                reportContent.textContent = report;
                operatorTrucksCompleted.push(currentTruckName);
                operatorTrucksPending = operatorTrucksPending.filter(p => p.truckName !== currentTruckName);

                speak('Carga de cami√≥n finalizada. Revisa el informe.');
                showOperatorScreen('op-truck-report-screen');
            };

            window.finishJourney = () => {
                const journeyEndTime = new Date();
                const totalTimeMin = Math.round((journeyEndTime - journeyStartTime) / 60000);

                let report = `--- INFORME DE JORNADA ---\n\n`;
                report += `Fecha: ${journeyEndTime.toLocaleDateString('es-ES')}\n`;
                report += `Hora Inicio Jornada: ${formatTime(journeyStartTime)}\n`;
                report += `Hora Fin Jornada: ${formatTime(journeyEndTime)}\n`;
                report += `Tiempo Total: ${totalTimeMin} minutos\n\n`;
                report += `--- CAMIONES CARGADOS (${operatorTrucksCompleted.length}) ---\n`;
                report += operatorTrucksCompleted.join(', ') || 'Ninguno';
                report += `\n\n`;

                if (allJourneyIncidents.length > 0) {
                    report += `--- RESUMEN DE INCIDENCIAS (${allJourneyIncidents.length}) ---\n`;
                    allJourneyIncidents.forEach(inc => { report += `- ${inc}\n`; });
                } else {
                    report += `--- SIN INCIDENCIAS EN LA JORNADA ---`;
                }

                journeyReportContent.textContent = report;
                speak('Jornada finalizada. Revisa el informe final.');
                showOperatorScreen('op-journey-report-screen');
            };

            window.shareReport = (via, textContent, subject) => {
                const text = textContent;
                let url = '';
                if (via === 'whatsapp') {
                    // Limpia el texto para WhatsApp (solo permite espacios, saltos de l√≠nea y texto)
                    const cleanText = text.replace(/(\t|\r)/g, '').trim();
                    url = `https://wa.me/?text=${encodeURIComponent(cleanText)}`;
                } else {
                    url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
                }
                window.open(url, '_blank');
            };
            
            // --- L√ìGICA MODO OPERARIO - INVENTARIO DE CIERRE ---

            window.startInventoryReport = () => {
                currentInventory = {};
                opInventoryList.innerHTML = '<p style="color: #ccc; text-align: center;">A√∫n no hay productos en el inventario de cierre.</p>';
                opInventoryCodeInput.value = '';
                opInventoryQtyInput.value = '';
                showOperatorScreen('op-inventory-screen');
                speak('Iniciando inventario de cierre. Introduce c√≥digo y cantidad.');
            };

            window.addInventoryItem = () => {
                const code = opInventoryCodeInput.value.trim();
                const qty = parseInt(opInventoryQtyInput.value);

                if (!code) { alert('C√≥digo es obligatorio.'); return; }
                if (isNaN(qty) || qty < 0) { alert('Cantidad debe ser un n√∫mero positivo.'); return; }

                // El Operario no necesita la DB de Productos, pero es bueno tener una descripci√≥n.
                const desc = productDB[code] ? productDB[code].desc : 'Producto Desconocido (verificar)';

                currentInventory[code] = { qty, desc };

                // Limpiar y Enfocar para la siguiente entrada
                opInventoryCodeInput.value = '';
                opInventoryQtyInput.value = '';
                opInventoryCodeInput.focus();
                renderCurrentInventoryList();
            };

            const renderCurrentInventoryList = () => {
                opInventoryList.innerHTML = '';
                const codes = Object.keys(currentInventory);
                if (codes.length === 0) {
                    opInventoryList.innerHTML = '<p style="color: #ccc; text-align: center;">A√∫n no hay productos en el inventario de cierre.</p>';
                    return;
                }

                codes.sort().forEach(code => {
                    const item = currentInventory[code];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${code}</strong> (${item.desc.substring(0, 30)}): <strong>${item.qty} uds.</strong> <button onclick="deleteInventoryItem('${code}')" class="danger" style="padding: 5px; margin-left: 10px;">X</button>`;
                    opInventoryList.appendChild(li);
                });
            };

            window.deleteInventoryItem = (code) => {
                delete currentInventory[code];
                renderCurrentInventoryList();
            };

            window.generateInventoryReport = () => {
                const codes = Object.keys(currentInventory);
                if (codes.length === 0) { alert('No hay datos para el informe.'); return; }

                let report = `--- REPORTE DE INVENTARIO DE CIERRE ---\n\n`;
                report += `Fecha: ${new Date().toLocaleDateString('es-ES')}\n\n`;
                report += `INSTRUCCI√ìN PARA OFICINA: Pegar el CSV a continuaci√≥n en la opci√≥n 'Importar CSV (Actualizaci√≥n Masiva)'\n\n`;
                report += `Codigo,Cantidad\n`; // Encabezado de CSV para la importaci√≥n f√°cil
                
                // Generaci√≥n del CSV
                codes.forEach(code => {
                    report += `${code},${currentInventory[code].qty}\n`;
                });

                inventoryReportContent.textContent = report;
                showOperatorScreen('op-inventory-report-screen');
                speak('Reporte de inventario generado. Listo para enviar.');
            };

            // --- ASIGNACI√ìN DE EVENTOS (OFICINA) ---
            processButton.addEventListener('click', processPedido);
            generateTransferButton.addEventListener('click', generateTransferText);
            copyTransferTextButton.addEventListener('click', copyTransferText);
            clearPlansButton.addEventListener('click', clearPreparedPlans);
            addProductButton.addEventListener('click', addProduct);
            clearProductFormButton.addEventListener('click', clearProductForm);
            clearProductsButton.addEventListener('click', clearAllProducts);
            searchProductInput.addEventListener('input', () => setTimeout(renderProductList, 0));
            exportProductsButton.addEventListener('click', exportProducts);
            toggleCsvButton.addEventListener('click', toggleCsvImport);
            importCsvButton.addEventListener('click', importCsvProducts);
            addTruckButton.addEventListener('click', addTruck);
            clearTrucksButton.addEventListener('click', clearAllTrucks);

            // --- EVENTOS DE ALMAC√âN ---
            addWarehouseButton.addEventListener('click', addWarehouseProduct);
            clearWarehouseButton.addEventListener('click', clearAllWarehouse);
            searchWarehouseInput.addEventListener('input', () => setTimeout(renderWarehouseList, 0));
            shareCheckoutWhatsappButton.addEventListener('click', () => {
                const report = checkoutReportContent.textContent;
                // shareReport obtiene el nombre del cami√≥n del contenido del reporte
                shareReport('whatsapp', report, 'Aviso de Retiro');
            });
            toggleCsvWarehouseButton.addEventListener('click', toggleCsvWarehouseImport);
            importCsvWarehouseButton.addEventListener('click', importCsvWarehouse);
            exportWarehouseButton.addEventListener('click', exportWarehouse);


            // --- ASIGNACI√ìN DE EVENTOS (OPERARIO) ---
            opStartJourneyButton.addEventListener('click', startJourney);
            opLoadPlansButton.addEventListener('click', loadPlansFromText);
            opTruckCancelStartButton.addEventListener('click', () => showOperatorScreen('op-truck-list-screen'));
            opTruckStartButton.addEventListener('click', startTruckLoad);
            operatorNextButton.addEventListener('click', () => { currentStep++; showStep(currentStep); });
            operatorIncidentButton.addEventListener('click', recordIncident);
            operatorAbandonButton.addEventListener('click', () => {
                if (confirm('¬øSeguro que quieres abandonar la carga? Volver√°s a la lista.')) {
                    speak('Carga abandonada');
                    renderOperatorTruckList();
                    showOperatorScreen('op-truck-list-screen');
                }
            });
            opTruckReportExitButton.addEventListener('click', () => {
                renderOperatorTruckList();
                showOperatorScreen('op-truck-list-screen');
            });
            opFinishJourneyButton.addEventListener('click', finishJourney);
            opJourneyReportExitButton.addEventListener('click', () => showOperatorScreen('op-welcome-screen'));

            operatorWhatsappButton.addEventListener('click', () => shareReport('whatsapp', reportContent.textContent, ''));
            operatorEmailButton.addEventListener('click', () => shareReport('email', reportContent.textContent, `Informe de Carga - ${currentTruckName}`));
            journeyWhatsappButton.addEventListener('click', () => shareReport('whatsapp', journeyReportContent.textContent, ''));
            journeyEmailButton.addEventListener('click', () => shareReport('email', journeyReportContent.textContent, 'Informe de Jornada de Carga'));
            
            // --- EVENTOS DE INVENTARIO DE CIERRE (OPERARIO) ---
            opStartInventoryButton.addEventListener('click', startInventoryReport);
            opAddInventoryItemButton.addEventListener('click', addInventoryItem);
            opGenerateInventoryReportButton.addEventListener('click', generateInventoryReport);
            inventoryWhatsappButton.addEventListener('click', () => shareReport('whatsapp', inventoryReportContent.textContent, 'Reporte de Inventario de Cierre'));
            inventoryEmailButton.addEventListener('click', () => shareReport('email', inventoryReportContent.textContent, 'Reporte de Inventario de Cierre'));
            opInventoryReportExitButton.addEventListener('click', () => showOperatorScreen('op-welcome-screen'));

            // --- RENDERIZADO INICIAL ---
            setTimeout(() => {
                renderProductList();
                renderTruckList();
                renderWarehouseList();
                renderPreparedPlansList();
                resultDiv.innerHTML = 'Listo para procesar. Pega un pedido y pulsa "Procesar y A√±adir a Lote".';
                resultDiv.className = '';
                showOfficeMode();
            }, 50);
        });
    </script>

</body>
</html>